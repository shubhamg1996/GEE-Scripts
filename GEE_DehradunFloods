var pt = ee.Geometry.Point(78.02970886230469,30.31539496677952); 
// var roi = pt.buffer(100000/2);
var SCALE = 30; // meters
// Load Sentinel-1 C-band SAR Ground Range collection (log scaling, VV co-polar)
var dehradun = ee.Geometry.Polygon({coords:
[[[78.02464485168457, 30.23422825137443],
          [78.02953720092773, 30.238899936598244],
          [78.02996635437012, 30.24060541714855],
          [78.02867889404297, 30.242533316047716],
          [78.03022384643555, 30.249354808470326],
          [78.02919387817383, 30.251801532743798],
          [78.03485870361328, 30.25802928319376],
          [78.0410385131836, 30.26040165569161],
          [78.04773330688477, 30.2657392842738],
          [78.0494499206543, 30.265294492973805],
          [78.05477142333984, 30.266480598629396],
          [78.05391311645508, 30.264256638771343],
          [78.05562973022461, 30.26247743461654],
          [78.05923461914062, 30.26232916614846],
          [78.06026458740234, 30.25862238169073],
          [78.06352615356445, 30.26351530762463],
          [78.06884765625, 30.268556249047727],
          [78.07073593139648, 30.267666689956158],
          [78.0743408203125, 30.276561918141727],
          [78.08326721191406, 30.26232916614846],
          [78.08103561401367, 30.26158782045005],
          [78.08429718017578, 30.256398243859493],
          [78.08704376220703, 30.256101688343282],
          [78.08910369873047, 30.25239466884559],
          [78.09305191040039, 30.252246385155885],
          [78.09494018554688, 30.244683620203222],
          [78.09854507446289, 30.241569371325433],
          [78.0988883972168, 30.23815841408509],
          [78.10026168823242, 30.234895648570816],
          [78.10832977294922, 30.23993805871847],
          [78.11468124389648, 30.234302406842197],
          [78.11983108520508, 30.229852979770175],
          [78.12395095825195, 30.23103951334467],
          [78.1321907043457, 30.2271832268762],
          [78.1344223022461, 30.241865970708517],
          [78.12884330749512, 30.26292223867753],
          [78.12678337097168, 30.271669642392517],
          [78.1241226196289, 30.273078049800244],
          [78.1208610534668, 30.279600936340028],
          [78.12043190002441, 30.284566934248893],
          [78.12000274658203, 30.287086896752637],
          [78.1157112121582, 30.288495082899836],
          [78.11056137084961, 30.2907926063742],
          [78.11141967773438, 30.29242307425726],
          [78.10935974121094, 30.29405351503604],
          [78.10893058776855, 30.2980553911198],
          [78.10626983642578, 30.299166994382315],
          [78.10523986816406, 30.306651461574624],
          [78.09974670410156, 30.308133466508973],
          [78.09794425964355, 30.31020823577287],
          [78.08979034423828, 30.317617767459435],
          [78.08730125427246, 30.31895142366329],
          [78.0867862701416, 30.322804106276315],
          [78.0853271484375, 30.327471576457697],
          [78.08773040771484, 30.329101434284162],
          [78.08876037597656, 30.330583099680148],
          [78.08764457702637, 30.332509231181362],
          [78.08841705322266, 30.333027798573955],
          [78.0879020690918, 30.3366576934265],
          [78.08944702148438, 30.339991151787938],
          [78.08833122253418, 30.34206524637164],
          [78.09296607971191, 30.35050932058973],
          [78.09914588928223, 30.35065745573957],
          [78.09674263000488, 30.35524953414852],
          [78.09914588928223, 30.356878929518498],
          [78.10481071472168, 30.35524953414852],
          [78.10824394226074, 30.36198912986571],
          [78.10678482055664, 30.364877385878344],
          [78.10910224914551, 30.365099555884782],
          [78.11081886291504, 30.366284454061493],
          [78.10901641845703, 30.367839611130602],
          [78.10901641845703, 30.371023903195617],
          [78.11159133911133, 30.37480048725028],
          [78.11408042907715, 30.37679979621592],
          [78.11347961425781, 30.37857692541186],
          [78.11622619628906, 30.378058599400642],
          [78.11983108520508, 30.38153873560255],
          [78.1226634979248, 30.38257534796433],
          [78.12463760375977, 30.384130245890272],
          [78.11270713806152, 30.384130245890272],
          [78.10609817504883, 30.388646713839144],
          [78.10747146606445, 30.39264472437119],
          [78.10446739196777, 30.39027555269495],
          [78.10232162475586, 30.393385078736916],
          [78.0977725982666, 30.393607183952472],
          [78.10026168823242, 30.39634644008742],
          [78.10077667236328, 30.39841933961184],
          [78.09614181518555, 30.401750693103132],
          [78.09511184692383, 30.40545206369539],
          [78.08953285217285, 30.40574816728145],
          [78.09073448181152, 30.409671455017673],
          [78.08755874633789, 30.410855812785396],
          [78.08352470397949, 30.408487082880843],
          [78.07253837585449, 30.412114177168935],
          [78.05777549743652, 30.409819500524463],
          [78.05331230163574, 30.404341667249998],
          [78.05230379104614, 30.398696956743187],
          [78.05058717727661, 30.393588675203777],
          [78.04758310317993, 30.389220512443323],
          [78.04681062698364, 30.384019182573184],
          [78.0404806137085, 30.373504617006038],
          [78.03307771682739, 30.371968062886168],
          [78.02599668502808, 30.372245755177588],
          [78.02138328552246, 30.368376504851692],
          [78.01440954208374, 30.3653957817749],
          [78.00556898117065, 30.366987980561024],
          [77.99745798110962, 30.35715666465847],
          [77.99342393875122, 30.35245357658663],
          [77.9975438117981, 30.350527837495736],
          [78.00958156585693, 30.34475039283115],
          [78.01305770874023, 30.338065167468166],
          [77.98284530639648, 30.33258331240559],
          [77.9861068725586, 30.32680480862026],
          [77.99829483032227, 30.31909960656536],
          [77.99365997314453, 30.313764880900646],
          [77.98490524291992, 30.315246778274663],
          [77.9835319519043, 30.319247789243317],
          [77.97683715820312, 30.312727539405046],
          [77.96052932739258, 30.280119783700034],
          [77.96293258666992, 30.272559165211643],
          [77.97237396240234, 30.275672431597897],
          [77.98147201538086, 30.268111470509467],
          [77.98078536987305, 30.2620326285407],
          [77.98198699951172, 30.25862238169073],
          [77.99331665039062, 30.266332336206055],
          [77.99795150756836, 30.263218773598812],
          [77.99297332763672, 30.259363749775257],
          [77.99846649169922, 30.255212016422448],
          [78.0029296875, 30.259363749775257],
          [78.00704956054688, 30.254767177440193],
          [78.01254272460938, 30.250170389998612],
          [78.02181243896484, 30.251208393060832],
          [78.01992416381836, 30.23474733847429]]]});
var collection =  ee.ImageCollection('COPERNICUS/S1_GRD').filterBounds(pt)
.filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VV'))
.select('VV');
//print(collection);
var before = collection.filterDate('2017-07-01', '2017-07-08').mosaic();
var after = collection.filterDate('2017-07-09', '2017-07-15').mosaic();
//print(on);
//print(after);
// Threshold smoothed radar intensities to identify "flooded" areas.
var SMOOTHING_RADIUS = 100;
var DIFF_UPPER_THRESHOLD = -3; 
var diff_smoothed = after.focal_median(SMOOTHING_RADIUS, 'circle', 'meters')
    .subtract(before.focal_median(SMOOTHING_RADIUS, 'circle', 'meters'));
//var diff_smoothed_Lee = toDB(RefinedLee(toNatural(after))).subtract(toDB(RefinedLee(toNatural(before))));
var diff_smoothed_Lee = after.subtract(before);
var diff_thresholded = diff_smoothed.lt(DIFF_UPPER_THRESHOLD);
var diff_thresholded_Lee = diff_smoothed_Lee.lt(DIFF_UPPER_THRESHOLD);
Map.centerObject(pt, 10);
Map.addLayer(before.clip(dehradun),{min:-30,max:0}, 'Before flood',0);
Map.addLayer(after.clip(dehradun), {min:-10,max:10}, 'After flood',0);
//Map.addLayer(after.clip(dehradun).subtract(before), {min:-10,max:10}, 'After - before', 0); 
//Map.addLayer(diff_smoothed.clip(dehradun), {min:-10,max:10}, 'diff smoothed', 0); 
Map.addLayer(diff_smoothed_Lee.clip(dehradun), {min:-10,max:10}, 'diff smoothed refined Lee', 0); 
var flood = diff_thresholded.updateMask(diff_thresholded);
Map.addLayer(flood.clip(dehradun), {palette:"0000FF"},'flooded areas',0);
flood = flood.unmask().focal_mode({radius:SCALE, iterations:3, units:'meters'})
flood = flood.mask(flood)
Map.addLayer(flood.clip(dehradun), {palette:"0000FF"},'flooded areas (large)',1);
//Map.addLayer(diff_thresholded_Lee.clip(dehradun).updateMask(diff_thresholded_Lee), {palette:"0000FF"},'flooded areas (Lee)',0);

// var density2017 = ee.Image('CIESIN/GPWv4/unwpp-adjusted-population-density/2017').clip(dehradun);

// var logDensity = density2017.where(density2017.gt(0), density2017.log());

// Load the ancillary data grids and map the log of the mean admin unit
// area.

var count2015 = ee.Image('CIESIN/GPWv4/population-count/2015');

var pixel_polys = flood.clip(dehradun).reduceToVectors({
 scale: 100,
 maxPixels:1e13
 });

print(ee.FeatureCollection(pixel_polys));
// print(ee.FeatureCollection.size(pixel_polys2));

var total =(count2015.reduceRegion('sum',dehradun));
var affected = (count2015.reduceRegion('sum',pixel_polys));
print('total population',total);
print('affected by flood',affected);
Map.addLayer(count2015.clip(dehradun));
Map.addLayer(dehradun);
Map.addLayer(pixel_polys);


// Export.table.toDrive({
//   collection: pixel_polys,
//   description: 'flood_areas',
//   folder: 'EE Exports'
// });
